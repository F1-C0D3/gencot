#! /bin/sh

# Modify an Isabelle theory. Intended to be applied to X_ShallowShared.thy or 
# X_ShallowShared_Tuples.thy generated by Cogent.
# This is a filter from stdin to stdout.

awk \
'{
  if ($0 == "This file is generated by Cogent") {
    print $0
    print "and modified by Gencot"
  } else if ($0 == "imports \"Cogent.Util\"") {
    print "imports \"CogentShallowUtil.Util\""
  } else if ($0 == "\"CogentShallow.ShallowUtil\"") {
    print "\"CogentShallowUtil.ShallowUtil\""
  } else if ($1 == "typedecl" && $3 == "MayNull") {
    printf("type_synonym %s MayNull = \"%s option\"\n", $2, $2)
  } else if ($1 == "type_synonym" && substr($3,1,7) == "CArrPtr" && substr($6,1,7) == "CArrPtr") {
    printf("type_synonym %s %s = \"%s list\"\n", $2, $3, $2)
  } else print
}' $1

# documentation:
#
# The theory is modified in the following ways:
# - after a line "This file is generated by Cogent" the line "and modified by Gencot" is inserted.
# - the line "imports "Cogent.Util"" is changed to "imports "CogentShallowUtil.Util""
# - the line "CogentShallow.ShallowUtil" is changed to "CogentShallowUtil.ShallowUtil"
# - every line
#     typedecl 'a MayNull
#   is replaced by
#     type_synonym 'a MayNull = "'a option"
# - every line
#     type_synonym 'el CArrPtr\<^sub>T = "'el CArrPtr"
#   is replaced by
#     type_synonym 'el CArrPtr\<^sub>T = "'el list"
#
# The modifications are implemented by matching lines and possibly replacing them by one or more lines.
# All non-matching lines are passed through.
#
# Implementation in awk:
# - Since in '...' the ' cannot be escaped, we avoid using it in match expressions and print it 
#   by reusing parts of the input.
