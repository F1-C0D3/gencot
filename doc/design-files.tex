\subsection{Cogent Source File Structure}
\label{design-files}

Although the Cogent source is not structured on the level of compilation units, Gencot intends to reflect the structure of 
the C program at the level of Cogent source files. 

Note, that there are four kinds of include statements available in Cogent source files. One is the \code{include} statement which
is part of the Cogent language. When it is used to include the same file several times in the same Cogent compilation unit,
the file content is automatically inserted only once. However, the Cogent preprocessor is executed separately for every file included 
with this \code{include} statement, thus preprocessor macros defined in an included file are not available in all other files. For 
this reason it cannot be used to reflect the file structure of a C program.

The second kind is the Cogent preprocessor \code{\#include} directive, it works like the C preprocessor \code{\#include} directive
and is used by Gencot to integrate the separate Cogent source files. 
The third kind is the preprocessor \code{\#include} directive 
which can be used in antiquoted Cogent files where the Cogent \code{include} statement is not available. This is only possible 
if the included content is also an antiquoted Cogent file. The fourth kind
is the \code{\#include} directive of the C preprocessor which can be used in antiquoted Cogent files in the form 
\code{\$esc:(\#include ...)}. It is only executed when the C code generated by the Cogent compiler is processed by the C compiler.
Hence it can be used to include normal C code.

Gencot assumes the usual C source structure: Every \code{.c} file contains definitions with internal or external linkage.
Every \code{.h}
file contains preprocessor constant definitions, type definitions and function declarations. The constants and type definitions 
are usually mainly those which are needed for the function declarations. Every \code{.c} file includes the \code{.h} file which
declares the functions which are defined by the \code{.c} file to access the constants and type definitions. Additionally it may
include other \code{.h} files to be able to invoke the functions declared there. A \code{.h} file may include other \code{.h} files
to reuse their constants and type definitions in its own definitions and declarations.

\subsubsection{Cogent Source Files}

In Cogent a function which is defined may not be declared as an abstract function elsewhere in the program. If the types and constants,
needed for defining a set of functions, should be moved to a separate file, like in C, this file must not contain the 
function declarations for the defined functions. Declarations for functions defined in Cogent are not needed at all, since the Cogent 
source is a single compilation unit and functions can be invoked at any place in a Cogent program, independently whether their definition 
is statically before or after this place.

Therefore we map every C source file \code{x.c} to a Cogent source file \code{x-impl.cogent} containing definitions of the same 
functions. We map every C include file \code{x.h} to a Cogent source file \code{x-types.cogent} 
containing the corresponding constant and type definitions, but omitting any function declarations. The include relations among 
\code{.c} and \code{.h} files are directly transferred to \code{-impl.cogent} and \code{-types.cogent} using the Cogent preprocessor 
\code{\#include} directive. 

Although it is named \code{x-types.cogent}, the file also contains Cogent value definitions generated from C preprocessor
constant definitions and from enumeration constants (see below). It would be possible to put the value definitions in a 
separate file. However, then for other preprocessor macro definitions it would not be clear where to put them, since they could
be used both in constant and type definitions. They cannot be moved to a common file included by both at the beginning,
since their position relative to the places where the macros are used is relevant.

This file mapping implies that for every translated \code{.c} file all directly or indirectly included \code{.h} files must be 
translated as well.
Alternatively, instead of using a Cogent type definition for every C type in an included \code{.h} file, a Cogent abstract type
can be used. In this way further included \code{.h} files may become unnecessary and need not be translated. However, this
must be decided and realized manually. Gencot always generates default Cogent type definitions and the include directives for all
\code{-types.cogent} files.

\subsubsection{External Name References}

For external name references Gencot generates the information required for Cogent. 
All generated type and constant definitions are put in the file \code{<package>-exttypes.cogent}.

Additionally, for all origin files used by at least one external reference, an include directive is put in the file
\code{<package>-extincludes.c}, to make the information available on the C level.

\subsubsection{Wrapper Definition Files}

The entry wrappers for the functions defined with external linkage in \code{x.c} are implemented in antiquoted Cogent code and
put in the file \code{x-entry.ac}. 

The exit wrappers for invoking C functions from Cogent are only created for the actual
external references in a processing step for the whole <package>. They are implemented in antiquoted Cogent
and put in the file \code{<package>-exit.ac}.

\subsubsection{Abstract Functions as Interface to C Functions}

If a Cogent function in \code{x-impl.cogent} invokes a function which is externally referenced and not defined in another
file \code{y-impl.cogent}, this function must be declared as an abstract function in Cogent. These abstract function declarations
are only created for the actual
external references in a processing step for the whole <package>. They are put in the file \code{<package>-exit.cogent}.

The implementation for these functions is provided by the exit wrappers in \code{<package>-exit.ac}.

\subsubsection{Abstract Types as Interface to C Types}

A C type can be used in Cogent in two possible ways. Either it is defined as a Cogent abstract type, or it is defined by providing
a Cogent type expression as definition. In the second case the Cogent compiler will generate a C type definition with the
same name. The Cogent type expression must be chosen in a way, that this C type definition is binary compatible to the
original C type definition, i.e., it has the same memory layout. Since Gencot always maps a C type name to a different Cogent
type name, both C type names do not conflict.

For an abstract type the Cogent compiler does not generate any definition, it is intended to directly refer to the original
C type. Since the Cogent type name is different from the C type name, or has been generated if the C type has no name,
Gencot generates a C type definition mapping the Cogent type name to the C type name.
However, this definition may only be present for abstract types, for the other types it would conflict with the C type
definition generated by the Cogent compiler. 

Abstract type definitions referencing an existing C type may be generated in the files \code{x-types.cogent}, 
\code{x-impl.cogent}, and \code{<package>-exttypes.cogent}. 

For file \code{x-types.cogent} we put the corresponding 
type mapping definitions in file \code{x-abstypes.h}. To make the information required for the referenced original 
C type definitions available in the Cogent compilation unit the file \code{x.h} must be 
included there as well. Note that this is 
possible without conflicts, since the type names generated by the Cogent compiler for non-abstract types are always
mapped and thus different from all types in \code{x.h} or included files.

For file \code{x-impl.cogent} we put the corresponding
type mapping definitions in the file \code{x-abstypes.c}. However, to make the information required for the 
referenced original C type definition
available, it is not possible to include \code{x.c}, since the C function definitions would conflict with their
entry wrappers in the Cogent compilation unit. Instead, the file \code{x-globals.c} is used, which is described in the
next section.

For file \code{<package>-exttypes.cogent} we put the corresponding
type mapping definitions in the file \code{<package>-exttypes.c}. The information required for the referenced original C type
definitions is always available, since all origin files for external references are included in the Cogent compilation unit.

\subsubsection{Global Variables}

In C a compilation unit can define global variables. Gencot does not generate an access interface to these variables
from Cogent code. However, the variables must still be present in a compilation unit, since they may be accessed
from other C compilation units (if they have external linkage). 

Gencot assumes that global variables are only defined in \code{.c} files. For every file \code{x.c} Gencot generates
the file \code{x-globals.c} containing all toplevel object definitions with external linkage in \code{x.c}. For 
these definitions, some type and constant definitions may be required, so they must also be added to \code{x-globals.c}.
Since the required types may be defined in included \code{.h} files, these files must be included in \code{x-globals.c}.
Instead of tracking, what is required for the global variable definitions, Gencot simply generates \code{x-globals.c}
from \code{x.c} by removing all function definitions and all object definitions with internal linkage. Note, that
this approach also makes all type definitions available which are needed by \code{x-abstypes.c}.

Toplevel object definitions with internal linkage cannot be accessed from other C compilation units. They cannot be
accessed from Cogent code either, hence they are useless, they must be replaced manually by a Cogent solution for
managing the corresponding global state. 

However, to inform the Cogent programmer about the global variables defined in \code{x.c} and their types, Gencot 
generates corresponding Cogent value definitions for all toplevel object definitions with internal or external linkage. 
For each of them the initializer is transferred unmodified from C, no Cogent expression for the defined value is 
generated. Either the initializer is manually converted to a Cogent expression, or the value definition is replaced
by another solution. 

All Cogent value definitions for global variables in \code{x.c} are put in the file \code{x-globals.cogent}. Since it
is only intended as an information for the Cogent programmer it is \textit{not} included automatically by any generated
Cogent source file. For external references to global variables no information is generated.

\subsubsection{Abstract Data Types}

There may also be cases of C types where no corresponding Cogent type can be defined, in this case it must be mapped to an 
abstract data type T in Cogent, consisting of an abstract type together with abstract functions. Both are put in 
the file \code{abstract/T.cogent} which must be included manually by all \code{x-types.cogent} where it is used. The types and 
functions of T must be implemented in additional C code. In contrast to the abstract functions defined in \code{<package>-exit.cogent},
there are no existing C files where these functions are implemented. The implementations are provided as antiquoted Cogent 
code in the file \code{abstract/T.ac}. If T is generic, the additional file \code{abstract/T.ah} is required for 
implementing the types, otherwise they are implemented in \code{abstract/T.h}. 

Gencot does not provide any support for using abstract data types, they must be managed manually according to the following
proposed schema. All related files should be stored in the subdirectory \code{abstract}.
An abstract data type T is defined in the following files:
\begin{description}
\item[\code{T.ac}] Antiquoted Cogent definitions of all functions of T. 
\item[\code{T.ah}] Antiquoted Cogent definition for T if T is generic.
\item[\code{T.h}] Antiquoted Cogent definitions of all non-generic types of T.
\end{description}
Using the flag \code{--infer-c-types} the Cogent compiler generates from \code{T.ah} files \code{T\_t1...tn.h} for all 
instantiations of T with type arguments t1...tn used in the Cogent code.

\subsubsection{File Summary}

Summarizing, Gencot uses the following kinds of Cogent source files for existing C source files \code{x.c} and \code{x.h}:
\begin{description}
\item[\code{x-impl.cogent}] Implementation of all functions defined in \code{x.c}. For each file \code{y.h} included by
  \code{x.c} the file \code{y-types.cogent} is included.
\item[\code{x-globals.cogent}] Value definitions for all objects defined in \code{x.c}. No files are included, the file is not
  included by any other file.
\item[\code{x-types.cogent}] Constant and type definitions for all constants and types defined in \code{x.h}. 
  If possible, for every C type definition a binary compatible Cogent type 
  definition is generated by Gencot. Otherwise an abstract type definition is used. Includes
  all \code{y-types.cogent} for which \code{x.h} includes \code{y.h}.
\item[\code{x-entry.ac}] Antiquoted Cogent definitions of entry wrapper functions for all function definitions with external linkage
  defined in \code{x.c}.
\item[\code{x-abstypes.h}] C definitions for abstract Cogent types defined in \code{x-types.cogent} used to reference existing C types.
\item[\code{x-abstypes.c}] C definitions for abstract Cogent types defined in \code{x-impl.cogent} used to reference existing C types.
\item[\code{x-globals.c}] Content of \code{x.c} with all function definitions removed.
\end{description}

For the Cogent compilation unit the following common files are used:
\begin{description}
\item[\code{<package>-exttypes.cogent}] Type and constant definitions for all external type and constant references.
\item[\code{<package>-exit.cogent}] Abstract function definitions for all external function references.
\item[\code{<package>-exit.ac}] Exit wrapper definitions for all external function references.
\item[\code{<package>-exttypes.c}] C type definitions for abstract types defined in \code{<package>-exttypes.cogent}.
\item[\code{<package>-extincludes.c}] Include directives for the origin files of all external references.
\end{description}

\subsubsection{Main Files}

To put everything together we use the files \code{<package>.cogent} and \code{<package>.ac}. The former includes all 
existing \code{x-impl.cogent} files and the files \code{<package>-exttypes.cogent} and \code{<package>-exit.cogent}.
It is the file processed by the Cogent compiler which translates it to files \code{<package>.c} 
and \code{<package>.h} where \code{<package>.c} includes \code{<package>.h}. 

The file \code{<package>.ac} includes all existing files 
\code{x-entry.ac}, and the files \code{<package>-exit.ac} and \code{<package>.c} and is processed by the Cogent compiler through the 
\code{--infer-c-funcs} flag. The resulting file is \code{<package>\_pp\_inferred.c} which is the C compilation unit for 
all parts of <package> already translated to Cogent. All existing files \code{x-abstypes.h} and \code{x-abstypes.c} 
and the files \code{<package>-exttypes.c} and \code{<package>-extincludes.c} are 
\code{\$esc}-included in \code{<package>.ac}, thus the corresponding normal includes for them are present in 
\code{<package>\_pp\_inferred.c}.
For all existing files \code{x-impl.cogent} the corresponding file \code{x-globals.c} is \code{\$esc}-included in 
\code{<package>.ac}, to make all global variables with external linkage and all type definitions in \code{x.c} 
a part of \code{<package>\_pp\_inferred.c}.

Every abstract type T yields an additional separate C compilation unit \code{T\_pp\_inferred.c}. 

The content of \code{abstract/T.h} and all \code{abstract/T\_t1...tn.h} is required in the compilation unit for T and in 
that for \code{<package>.c}. The Cogent compiler automatically generates includes for all \code{abstract/T\_t1...tn.h} in 
\code{<package>.h}, 
thus they are available in \code{<package>\_pp\_inferred.c}. By manually \code{\$esc}-including \code{<package>.h} in every 
\code{abstract/T.ac} they are made available there as well. In the same way \code{abstract/T.h} can be \code{\$esc}-included
in \code{abstract/T.ac}. To make it available in the \code{<package>.c} unit Gencot also \code{\$esc}-includes all 
existing \code{abstract/T.h} files in \code{<package>.ac}.

 
