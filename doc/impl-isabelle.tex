As described in Section~\ref{design-isabelle} Gencot extends the shallow embedding and 
the refinement proof generated by Cogent. This is implemented by
\begin{itemize}
\item providing predefined Isabelle code as theory files. These files are located 
in the Gencot distribution in the subfolder \code{isa}.
\item generating additional Isabelle code in separate theory files, if it depends 
on the translated C program.
\item modifying Isabelle code which has been generated by Cogent. This is only done
in cases where there is no other solution possible.
\end{itemize}

The Cogent refinement proof proceeds in several steps starting at the shallow embedding, through several intermediate
representations, ending at the representation of the C code abstracted by Autocorres. Gencot extends the proof by
generating similar steps for the additional Gencot and Cogent operations provided in the extended shallow embedding.

\subsection{Generating and Processing Isabelle Code}
\label{impl-isabelle-code}

\subsection{Extending the Shallow Embedding}
\label{impl-isabelle-shallow}

\subsubsection{Theory File Structure}

The shallow embedding generated by Cogent for a program \code{X} consists of two Isabelle theory files. The file 
\code{X\_ShallowShared\_Tuples.thy} contains definitions for all types occurring in the Cogent program and declarations
for all abstract functions in the Cogent program. The file \code{X\_Shallow\_Desugar\_Tuples.thy} contains definitions 
for all non-abstract functions defined in the Cogent program.

There is a third file \code{X\_ShallowConsts\_Desugar\_Tuples.thy} which contains Isabelle definitions for the constants 
defined in the Cogent program. It is only generated when the refinement proof to the first intermediate level is generated
using command \code{shallow-tuples-proof} for the Cogent compiler. However, this file is not used, all constants are 
substituted by their value in the shallow embedding. Therefore Gencot ignores this file.

This shallow embedding is transformed by Gencot to the following set of files:
\begin{description}
\item[\code{GencotTypes.thy}:] this file is predefined and contains definitions used for implementing the Gencot 
types in Isabelle.
\item[\code{X\_ShallowShared\_Tuples.thy}:] this is a modified form of the file generated by Cogent, where some type 
declarations and type synonym definitions have been replaced. The file additionally imports \code{GencotTypes.thy}
since its content may be used in the replaced type specifications.
\item[\code{ShallowShared\_Tuples.thy}:] this is a program specific file generated by Gencot. It only contains an import of 
\code{X\_ShallowShared\_Tuples.thy}. It serves as an interface so that the content of \code{X\_ShallowShared\_Tuples.thy} can be
imported in predefined files without the need to know the program specific prefix \code{X}.
\item[\code{Gencot\_TTT\_Tuples.thy}:] these are predefined files for every Gencot include file \code{TTT.cogent} which defines
abstract Cogent functions. They import \code{GencotTypes.thy} and \code{ShallowShared\_Tuples.thy} and define Isabelle
specifications for the abstract Cogent functions defined in \code{TTT.cogent}.
\item[\code{CogentCommon\_ttt\_Tuples.thy}:] these are predefined files for some Cogent include files \code{ttt.cogent} in the 
Cogent standard library \code{gum/common} which define abstract Cogent functions. They import \code{ShallowShared\_Tuples.thy}
and define Isabelle specifications for the abstract Cogent functions defined in \code{ttt.cogent}
\item[\code{X\_Shallow\_Gencot\_Tuples.thy}:] this is a program specific file generated by Gencot. It imports 
\code{X\_ShallowShared\_Tuples.thy} and all \code{Gencot\_TTT\_Tuples.thy} and \code{CogentCommon\_ttt\_Tuples.thy} 
for which \code{TTT.cogent} or \code{ttt.cogent} is used in the Cogent program, respectively. It may contain additional 
program specific parts of the shallow embedding. 
\item[\code{X\_Shallow\_Desugar\_Tuples.thy}:] this is the original file as generated by Cogent, with the only modification
that it imports \code{X\_Shallow\_Gencot\_Tuples.thy} instead of \code{X\_ShallowShared\_Tuples.thy}.
\end{description}

Together, the Gencot shallow embedding for a program \code{X} is made available in an Isabelle theory file by importing
\code{X\_Shallow\_Desugar\_Tuples.thy}. This file structure is designed with the goal to reduce modifications and program 
specific parts, which must be generated, to an absolute minimum.

The predefined files \code{GencotTypes.thy}, \code{Gencot\_TTT\_Tuples.thy} and \code{CogentCommon\_ttt\_Tuples.thy} are provided in 
directory \code{isa} in the Gencot distribution. However, they cannot be loaded directly from there by Isabelle, 
since they depend on the program specific file \code{ShallowShared\_Tuples.thy} and no complete session can be defined for 
them in the Gencot distribution. For a complete shallow embedding which can be loaded by Isabelle the predefined
files must be copied from the Gencot distribution to the directory where the other files have been generated. Then 
a session can be defined for them in a \code{ROOT} file there.

It would be possible to determine from the imports in \code{X\_Shallow\_Gencot\_Tuples.thy} exactly those predefined
files which are needed for a specific shallow embedding. However, transitive imports among the predefined files
must be taken into account. Therefore a simpler solution is to always copy all predefined theory files to a 
specific shallow embedding, independent of which are actually needed.

\subsection{Extending the Shallow Tuples Proof}
\label{impl-isabelle-reftuples}

The first intermediate representation used by Cogent is directly equivalent to the Cogent core language. The shallow 
embeddding is actually generated from this representation by reversing the replacement of Cogent tuple types by record types
in the core language. As a consequence, both representations have a similar structure and the theory files are named
by omitting the \code{\_Tuples} part from the shallow embedding file names.

The extensions provided by Gencot for the intermediate representation follow the same approach and the same naming scheme.
It consists of the generated files \code{ShallowShared.thy}, \code{Gencot\_TTT.thy}, \code{CogentCommon\_ttt.thy}, 
\code{X\_Shallow\_Gencot.thy}, the modified files \code{X\_ShallowShared.thy} and \code{X\_Shallow\_Desugar\_Tuples.thy}, 
and the file \code{GencotTypes.thy} which is common for both representations.

Cogent generates the refinement proof between both representations in a single theory file \code{X\_ShallowTuplesProof.thy}.
This file imports program-independent parts of the proof from theory file \code{ShallowTuples.thy}. Gencot extends the 
proof by modifying \code{X\_ShallowTuplesProof.thy} and providing additional program-independent parts in the theory 
file \code{ShallowTuples\_Gencot.thy}.
